---
title: "Midterm Project: Yelp Data Challenge"
author: "Xiang Zhao"
date: "12/2/2017"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(dplyr)
library(tidyr)
library(lme4)
library(VGAM)
library(ggplot2)
library(arm)
library(knitr)
library(grid)
library(gridExtra)
```

# 1. Introduction

##Yelp is a website and also an app collecting the informations of business holders and users. With the increasing population from asia, the number of asian restaurants rising quickly and have been more popular than before. For asian restaurants' holders, in order to offer a better quality for customers and making more profits, analyzing the relationship between the rate of restaurants and restaurants' and users' informations is important. So, I collected the data from Yelp using SQL in R and filter four styles of restaurants, Chinese, Japanese, Korean and Southeast Asian restaurants with their attributes like price range and noise level and so on to fit several models to find the relationship between the rate and restaurants' and users' informations.

##At the beginning, I collected the data with all the informations and attributes of restaurants and informations of users. I filter the Chinses, Japanese, Korean and Southeast Asian restaurants with all their informations first. Then I filter six attributes:whether a restaurant has free/paid/no WiFi, the price range of the restaurant, the choices of parking of a restaurant, the noise level of a restaurant, whether a restaurant has a TV or not and whether a restaurant has outdoor seating or not. Next I combined the 'attributes' dataset with 'business' dataset, which gives a whole dataset containing all the informations and attributes of four styles of restaurants. Later, I filter the stars rated by users from 'review' dataset and join it with the 'user' dataset containing users' informations. Finally I join the two datasets of users& reviews and restaurants' informations into one dataset and named it "yelp" which has 472741 rows and 22 variables after cleaning all the NAs.

##After getting the clean dataset, I first did EDA especially on the relationships between predictors and response graphically. Then I designed several models to analyze and check these potential relationships statistically and numerically. Finally I summarized the conclusions.

\newpage
# 2. Data & Method

##2.1 Data source

###The data is from yelp: https://www.yelp.com/dataset/challenge.
###Due to the huge size of dataset after filtering, I saved the filtered dataset into RDS file and reread it in another Rmd file then analyzing. If you need to see the code of reading and cleaning the data, look at 'Data collecting & cleaning.Rmd'.

###Part of data shows below:
###1st-5th columns:
```{r}
yelp <- readRDS("restaurants_users.rds")
kable(head(yelp[,1:5]))
```

###6th-9th columns:

```{r}
kable(head(yelp[,6:9]))
```

###10th-13rd columns:

```{r}
kable(head(yelp[,10:14]))
```

###15th-17th columns:

```{r}
kable(head(yelp[,15:17]))
```

###18th-22nd columns:

```{r}
kable(head(yelp[,18:22]))
```

```{r}
#After checking the dataset for inputting errors, I found 3 data points with unusual format in 'restaurant_state'. So I delect these 3 rows.
#yelp%>%
#  count(restaurant_state)
yelp$restaurant_state[yelp$restaurant_state == "01"] <- NA
yelp <- na.omit(yelp)
#Sampel the subset of data to fit the model.
set.seed(168)
mysample <- yelp[sample(1:nrow(yelp),1000,replace = F),]
saveRDS(mysample,"mysample.rds")
```

##2.2 Method

###Tools: SQL, R, csv, RDS, online searching
###Packages & Functions: ggplot2::ggplot, lme4::lmer&glmer, VGAM::vglm
###Models: Multilevel linear model, ordered categorical regression

\newpage
# 3.EDA

##3.1 Histogram of stars rated by users toward each four styles of restaurants

```{r}
chinese <- yelp%>%
  filter(restaurant_style == "Chinese")

japanese <- yelp%>%
  filter(restaurant_style == "Japanese")

korean <- yelp%>%
  filter(restaurant_style == "Korean")

se_asian <- yelp%>%
  filter(restaurant_style == "Southeast Asian")

par(mfrow=c(2,2))
hist.1 <- hist(chinese$user_stars)
hist.2 <- hist(japanese$user_stars)
hist.3 <- hist(korean$user_stars)
hist.4 <- hist(se_asian$user_stars)
title("Figure3.1: Histogram of stars rated by users toward each four styles of restaurants", outer=TRUE)
```

##3.2 Histogram of average stars of each four styles of restaurants

```{r}
par(mfrow=c(2,2))
hist(chinese$restaurant_stars)
hist(japanese$restaurant_stars)
hist(korean$restaurant_stars)
hist(se_asian$restaurant_stars)
title("Figure3.2: Histogram of average stars of each four styles of restaurants", outer=TRUE)
```

##3.3 Stacked bar plot of count of stars within each predictor.

```{r}
style_stars <- yelp %>%
  group_by(restaurant_style)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
style.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_style, fill = factor(user_stars)), data = style_stars, stat="identity")
style.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_style, fill = factor(user_stars)), data = style_stars, stat="identity")
```

```{r}
WiFi_stars <- yelp %>%
  group_by(restaurant_WiFi)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
wifi.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_WiFi, fill = factor(user_stars)), data = WiFi_stars, stat="identity")
wifi.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_WiFi, fill = factor(user_stars)), data = WiFi_stars, stat="identity")
```

```{r}
price_stars <- yelp %>%
  group_by(restaurant_price_range)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
price.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_price_range, fill = factor(user_stars)), data = price_stars, stat="identity")
price.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_price_range, fill = factor(user_stars)), data = price_stars, stat="identity")
```

```{r}
garage_stars <- yelp %>%
  group_by(garage_parking)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
garage.1 <- ggplot() + geom_bar(aes(y = n, x = garage_parking, fill = factor(user_stars)), data = garage_stars, stat="identity")
garage.2 <- ggplot() + geom_bar(aes(y = percent, x = garage_parking, fill = factor(user_stars)), data = garage_stars, stat="identity")
```

```{r}
street_stars <- yelp %>%
  group_by(street_parking)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
street.1 <- ggplot() + geom_bar(aes(y = n, x = street_parking, fill = factor(user_stars)), data = street_stars, stat="identity")
street.2 <- ggplot() + geom_bar(aes(y = percent, x = street_parking, fill = factor(user_stars)), data = street_stars, stat="identity")
```

```{r}
validated_stars <- yelp %>%
  group_by(validated_parking)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
validated.1 <- ggplot() + geom_bar(aes(y = n, x = validated_parking, fill = factor(user_stars)), data = validated_stars, stat="identity")
validated.2 <- ggplot() + geom_bar(aes(y = percent, x = validated_parking, fill = factor(user_stars)), data = validated_stars, stat="identity")
```

```{r}
lot_stars <- yelp %>%
  group_by(lot_parking)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
lot.1 <- ggplot() + geom_bar(aes(y = n, x = lot_parking, fill = factor(user_stars)), data = lot_stars, stat="identity")
lot.2 <- ggplot() + geom_bar(aes(y = percent, x = lot_parking, fill = factor(user_stars)), data = lot_stars, stat="identity")
```

```{r}
valet_stars <- yelp %>%
  group_by(valet_parking)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
valet.1 <- ggplot() + geom_bar(aes(y = n, x = valet_parking, fill = factor(user_stars)), data = valet_stars, stat="identity")
valet.2 <- ggplot() + geom_bar(aes(y = percent, x = valet_parking, fill = factor(user_stars)), data = valet_stars, stat="identity")
```

```{r}
noise_stars <- yelp %>%
  group_by(restaurant_noise_level)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
noise.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_noise_level, fill = factor(user_stars)), data = noise_stars, stat="identity")
noise.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_noise_level, fill = factor(user_stars)), data = noise_stars, stat="identity")
```

```{r}
TV_stars <- yelp %>%
  group_by(restaurant_TV)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
tv.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_TV, fill = factor(user_stars)), data = TV_stars, stat="identity")
tv.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_TV, fill = factor(user_stars)), data = TV_stars, stat="identity")
```

```{r}
outdoor_stars <- yelp %>%
  group_by(restaurant_outdoor_seating)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
outdoor.1 <- ggplot() + geom_bar(aes(y = n, x = restaurant_outdoor_seating, fill = factor(user_stars)), data = outdoor_stars, stat="identity")
outdoor.2 <- ggplot() + geom_bar(aes(y = percent, x = restaurant_outdoor_seating, fill = factor(user_stars)), data = outdoor_stars, stat="identity")
```

```{r}
useraverage_stars <- yelp %>%
  group_by(user_average_stars)%>%
  count(user_stars)%>%
  mutate(percent = n/sum(n))
avg.1 <- ggplot() + geom_jitter(aes(y = user_stars, x = user_average_stars, color = factor(user_stars)), data = useraverage_stars)

avg.2 <- ggplot() + geom_bar(aes(y = percent, x = user_average_stars, fill = factor(user_stars)), data = useraverage_stars, stat="identity")
```

```{r,fig.height=15,fig.width=15}
grid.arrange(style.1,wifi.1,price.1,garage.1,street.1,validated.1,lot.1,valet.1,noise.1,tv.1,outdoor.1,avg.1,ncol = 3,bottom = "Figure3.3: Stacked bar plot of count of stars within each predictor")
```

##3.4 Stacked bar plot of percentage of stars within each predictor.

```{r,fig.width=15,fig.height=15}
grid.arrange(style.2,wifi.2,price.2,garage.2,street.2,validated.2,lot.2,valet.2,noise.2,tv.2,outdoor.2,avg.2,ncol = 3,bottom = "Figure3.4: Stacked bar plot of percentage of stars within each predictor")
```

\newpage
# 4.Model fitting & Analysis

##4.1 Categorical Regression

###I first fit a categorical regression with the star of a user rating for a certain restaurant as response and the style, price range, noise level, parking conditions and wifi, TV and outdoor seatings of a restaurant as predictors. This model does not have random effects. 

```{r}
yelp_fit.1 <- vglm(ordered(user_stars) ~ restaurant_style + restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating, family = cumulative(parallel = T), data = mysample)
summary(yelp_fit.1)

y_hat.1 <- data.frame(fitted.values(yelp_fit.1))
colnames(y_hat.1) <- c("1","2","3","4","5")
res.1 <- data.frame(resid(yelp_fit.1, type = "response"))
colnames(res.1) <- c("1","2","3","4","5")
```

```{r,fig.height=10,fig.width=15}
par(mfrow=c(3,2))
binnedplot(y_hat.1$`1`,res.1$`1`,main = "Binned residual plot of fitting 1 star")
binnedplot(y_hat.1$`2`,res.1$`2`,main = "Binned residual plot of fitting 2 stars")
binnedplot(y_hat.1$`3`,res.1$`3`,main = "Binned residual plot of fitting 3 stars")
binnedplot(y_hat.1$`4`,res.1$`4`,main = "Binned residual plot of fitting 4 stars")
binnedplot(y_hat.1$`5`,res.1$`5`,main = "Binned residual plot of fitting 5 stars")
title("Figure4.1: Binned residual plots for each category of rated stars", outer=TRUE)
```

##4.2 Multilevel linear model (combine four styles of restaurants and sample the data for regression)

```{r}
yelp_fit.2 <- lmer(user_stars ~ restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating + (1|restaurant_style) + (1|restaurant_city:restaurant_state), data = mysample)
summary(yelp_fit.2)

yelp_hat.2 <- fitted.values(yelp_fit.2)
yelp_res.2 <- resid(yelp_fit.2)
binnedplot(yelp_hat.2,yelp_res.2,main = "Figure4.2: Binned residual plot of fitting rated stars of sample data")
```

##4.3 Multilevel linear model (separate four styles of restaurants and fit model individually)

### First I fit the model only with data of Chinese restaurants.

```{r}
#Chinese
chinese_fit.1 <- lmer(user_stars ~ restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating + (1|restaurant_city:restaurant_state), data = chinese)
summary(chinese_fit.1)

chinese_coef <- data.frame(chinese_fit.1@beta)
chinese_se <- data.frame(sqrt(diag(vcov(chinese_fit.1))))

chinese_hat.1 <- fitted.values(chinese_fit.1)
chinese_res.1 <- resid(chinese_fit.1)
binnedplot(chinese_hat.1,chinese_res.1, main = "Figure4.3: Binned residual plot of fitting rated stars of Chinese restaurants")
```

### Second I fit the model only with data of Japanese restaurants.

```{r}
#Japanese
japanese_fit.1 <- lmer(user_stars ~ restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating + (1|restaurant_city:restaurant_state), data = japanese)
summary(japanese_fit.1)

japanese_coef <- data.frame(japanese_fit.1@beta)
japanese_se <- data.frame(sqrt(diag(vcov(japanese_fit.1))))

japanese_hat.1 <- fitted.values(japanese_fit.1)
japanese_res.1 <- resid(japanese_fit.1)
binnedplot(japanese_hat.1,japanese_res.1, main = "Figure4.4: Binned residual plot of fitting rated stars of Japanese restaurants")
```

### Third I fit the model only with data of Korean restaurants.

```{r}
#Korean
#korean_sample <- yelp[sample(1:nrow(yelp),6000,replace = F),]
korean_fit.1 <- lmer(user_stars ~ restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating + (1|restaurant_city:restaurant_state), data = korean)
summary(korean_fit.1)

korean_coef <- data.frame(korean_fit.1@beta)
korean_se <- data.frame(sqrt(diag(vcov(korean_fit.1)))) 

korean_hat.1 <- fitted.values(korean_fit.1)
korean_res.1 <- resid(korean_fit.1)
binnedplot(korean_hat.1,korean_res.1, main = "Figure4.5: Binned residual plot of fitting rated stars of Korean restaurants")
```

### Finally I fit the model only with data of Southeast Asian restaurants.

```{r}
#Southeast Asian
se_asian_fit.1 <- lmer(user_stars ~ restaurant_WiFi + restaurant_price_range + garage_parking + street_parking + validated_parking + lot_parking + valet_parking + restaurant_noise_level + restaurant_TV + restaurant_outdoor_seating + (1|restaurant_city:restaurant_state), data = se_asian)
summary(se_asian_fit.1)

se_coef <- data.frame(se_asian_fit.1@beta)
se_se <- data.frame(sqrt(diag(vcov(se_asian_fit.1)))) 

seasian_hat.1 <- fitted.values(se_asian_fit.1)
seasian_res.1 <- resid(se_asian_fit.1)
binnedplot(seasian_hat.1,seasian_res.1, main = "Figure4.6: Binned residual plot of fitting rated stars of Southeast Asian restaurants")
```

##4.4 Check and comparethe coefficients table

```{r}
coefs <- cbind(chinese_coef,japanese_coef,se_coef)


rownames(coefs) <- c("Intercept","restaurant_WiFino","restaurant_WiFipaid","restaurant_price_range2","restaurant_price_range3","restaurant_price_range4","garage_parking true","street_parking true","validated_parking true","lot_parking true","valet_parking true","restaurant_noise_levelloud","restaurant_noise_levelquiet","restaurant_noise_levelvery_loud","restaurant_TV1","restaurant_outdoor_seating1")

coefs[1:5,4] <- korean_coef[1:5,1]
coefs[6,4] <- NA
coefs[7:16,4] <- korean_coef[6:15,1]

colnames(coefs) <- c("Chinese","Japanese","Southeast Asian","Korean")

kable(coefs)
```

##4.5 Calculate 95% confidence interval and check the statistical significance

```{r,fig.width=9,fig.height=9}
chinese_coef$se <- chinese_se$sqrt.diag.vcov.chinese_fit.1...
chinese_coef$variable <- c("Intercept","restaurant_WiFino","restaurant_WiFipaid","restaurant_price_range2","restaurant_price_range3","restaurant_price_range4","garage_parking true","street_parking true","validated_parking true","lot_parking true","valet_parking true","restaurant_noise_levelloud","restaurant_noise_levelquiet","restaurant_noise_levelvery_loud","restaurant_TV1","restaurant_outdoor_seating1")
colnames(chinese_coef)[1] <- "coefficients"
chinese_coef$ymin <- chinese_coef$coefficients - 1.96*chinese_coef$se
chinese_coef$ymax <- chinese_coef$coefficients + 1.96*chinese_coef$se
chinese_coef <- chinese_coef[-1,]
ggplot(chinese_coef, aes(x=variable, y=coefficients)) + 
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax)) +
  geom_hline(yintercept = 0) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title = "Figure4.7: Point estimates and 95% confidence interval of coefficients of model for Chinese restaurants")
```

```{r,fig.width=9,fig.height=9}
japanese_coef$se <- japanese_se$sqrt.diag.vcov.japanese_fit.1...
japanese_coef$variable <- c("Intercept","restaurant_WiFino","restaurant_WiFipaid","restaurant_price_range2","restaurant_price_range3","restaurant_price_range4","garage_parking true","street_parking true","validated_parking true","lot_parking true","valet_parking true","restaurant_noise_levelloud","restaurant_noise_levelquiet","restaurant_noise_levelvery_loud","restaurant_TV1","restaurant_outdoor_seating1")
colnames(japanese_coef)[1] <- "coefficients"
japanese_coef$ymin <- japanese_coef$coefficients - 1.96*japanese_coef$se
japanese_coef$ymax <- japanese_coef$coefficients + 1.96*japanese_coef$se
japanese_coef <- japanese_coef[-1,]
ggplot(japanese_coef, aes(x=variable, y=coefficients)) + 
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax)) + 
  geom_hline(yintercept = 0) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title = "Figure4.8: Point estimates and 95% confidence interval of coefficients of model for Japanese restaurants")
```


```{r,fig.width=9,fig.height=9}
korean_coef$se <- korean_se$sqrt.diag.vcov.korean_fit.1...
korean_coef$variable <- c("Intercept","restaurant_WiFino","restaurant_WiFipaid","restaurant_price_range2","restaurant_price_range3","garage_parking true","street_parking true","validated_parking true","lot_parking true","valet_parking true","restaurant_noise_levelloud","restaurant_noise_levelquiet","restaurant_noise_levelvery_loud","restaurant_TV1","restaurant_outdoor_seating1")
colnames(korean_coef)[1] <- "coefficients"
korean_coef$ymin <- korean_coef$coefficients - 1.96*korean_coef$se
korean_coef$ymax <- korean_coef$coefficients + 1.96*korean_coef$se
korean_coef <- korean_coef[-1,]
ggplot(korean_coef, aes(x=variable, y=coefficients)) + 
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax)) +
  geom_hline(yintercept = 0) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title = "Figure4.9: Point estimates and 95% confidence interval of coefficients of model for Korean restaurants")
```


```{r,fig.width=9,fig.height=9}
se_coef$se <- se_se$sqrt.diag.vcov.se_asian_fit.1...
se_coef$variable <- c("Intercept","restaurant_WiFino","restaurant_WiFipaid","restaurant_price_range2","restaurant_price_range3","restaurant_price_range4","garage_parking true","street_parking true","validated_parking true","lot_parking true","valet_parking true","restaurant_noise_levelloud","restaurant_noise_levelquiet","restaurant_noise_levelvery_loud","restaurant_TV1","restaurant_outdoor_seating1")
colnames(se_coef)[1] <- "coefficients"
se_coef$ymin <- se_coef$coefficients - 1.96*se_coef$se
se_coef$ymax <- se_coef$coefficients + 1.96*se_coef$se
se_coef <- se_coef[-1,]
ggplot(se_coef, aes(x=variable, y=coefficients)) + 
  geom_point(size=1.5) +
  geom_errorbar(aes(ymin=ymin, ymax=ymax)) + 
  geom_hline(yintercept = 0) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title = "Figure4.10: Point estimates and 95% confidence interval of coefficients of model for Southeast Asian restaurants")
```


```{r}
#Random effect
random <- data.frame(matrix(c(0.1033,0.1465,0.1203,0.09686),byrow = T))
colnames(random)[1] <- "city:state"
rownames(random) <- c("Chinese","Japanese","Korean","Southeast Asian")
kable(random)
```



